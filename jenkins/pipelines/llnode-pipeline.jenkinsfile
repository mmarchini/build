#!/usr/bin/env groovy

def pr = [] // Mutable parameter set to pass to jobs. I know this is crazy.
String printParams = '' // String of params to print
for (param in params) {
    printParams += param.toString() + '\n'
    if (param.key != 'NODE_VERSIONs') {
        pr.push(string(name: param.key, value: param.value))
    }
}
println "\n### BUILD PARAMETERS ###\n${printParams}"

stage('Test llnode') {
    def versions = params['NODE_VERSIONs'].split()
    def buildJobs = [:]
    for (int i = 0; i < versions.length; i++) {
        int index = i // locally scoped copy.
        def p = pr.collect() // local copy of params
        p.push(string(name: 'NODE_VERSION', value: versions[index]))
        buildJobs["${versions[index]}"] = { build(job: 'llnode-continuous-integration', parameters: p) }
    }

    println buildJobs
    parallel(buildJobs)
}
